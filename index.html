<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Метро</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFB5A7">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Метро%22,%22short_name%22:%22Метро%22,%22display%22:%22standalone%22,%22background_color%22:%22#F9F7F2%22}">

    <style>
        :root {
            --bg: #F9F7F2; 
            --panel: #FFFFFF;
            --accent: #FFB5A7; 
            --hit: #9DBEBB;   
            --text: #4A4E69;
        }
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--text); 
            text-align: center; margin: 0; padding: 15px; overflow-x: hidden;
            user-select: none; touch-action: manipulation;
        }
        .container { max-width: 500px; margin: auto; padding-bottom: 140px; }
        
        .top-controls { 
            display: flex; height: 90px; background: var(--panel); 
            margin: 10px 0 25px; border-radius: 28px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            overflow: hidden; border: 2px solid #EEEAE3;
        }
        .tempo-zone { flex: 1.2; background: #F2E9E4; border-right: 2px solid #EEEAE3; cursor: ew-resize; position: relative; }
        .tempo-zone::after { content: 'speed'; position: absolute; bottom: 8px; font-size: 11px; font-weight: 600; opacity: 0.3; width: 100%; left: 0; letter-spacing: 1px; }
        
        .volume-zone { flex: 1; padding: 0 20px; display: flex; align-items: center; }
        input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; }

        .preset-list { display: flex; gap: 10px; overflow-x: auto; padding: 5px 0; margin-bottom: 10px; scrollbar-width: none; }
        .preset-item { 
            background: var(--panel); padding: 10px 18px; border-radius: 18px; 
            font-weight: 600; border: 2px solid #EEEAE3; white-space: nowrap; font-size: 14px;
        }

        .btn-save { 
            background: var(--accent); color: white; border: none; 
            padding: 14px; border-radius: 20px; font-weight: 700; 
            box-shadow: 0 6px 15px rgba(255, 181, 167, 0.4); width: 100%; cursor: pointer;
        }

        .add-btns { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
        .btn-add { 
            width: 52px; height: 52px; border: none; border-radius: 20px; 
            font-weight: 700; font-size: 19px; cursor: pointer; 
            background: var(--panel); color: var(--text);
            box-shadow: 0 4px 10px rgba(0,0,0,0.04); transition: transform 0.1s;
        }
        .btn-add:active { transform: scale(0.9); }
        .btn-clear { background: #FCD5CE !important; color: #4A4E69 !important; }

        #workspace { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; min-height: 100px; }
        .step { 
            width: 62px; height: 82px; border-radius: 24px; background: var(--panel); 
            border: 2px solid #EEEAE3; position: relative; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .step.hit { background: var(--hit); border-color: transparent; color: white; }
        .step.accent { background: var(--accent); border-color: transparent; color: white; }
        .step.active-playing { transform: translateY(-12px); border-color: var(--text); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .step-num { font-size: 24px; font-weight: 700; opacity: 0.9; }
        .del-step { position: absolute; top: -6px; right: -6px; width: 24px; height: 24px; background: var(--text); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; border: 2px solid var(--bg); }

        .play-footer { position: fixed; bottom: 0; left: 0; width: 100%; padding: 25px; box-sizing: border-box; background: linear-gradient(transparent, var(--bg) 50%); }
        #playBtn { 
            width: 100%; max-width: 400px; padding: 22px; border-radius: 28px; 
            border: none; background: var(--text); color: white; 
            font-weight: 700; font-size: 20px; box-shadow: 0 10px 25px rgba(74, 78, 105, 0.3);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="top-controls">
        <div class="tempo-zone" id="tempoZone"></div>
        <div class="volume-zone"><input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.7"></div>
    </div>

    <div class="preset-list" id="presetList"></div>
    <button class="btn-save" onclick="saveCurrentPreset()">Сохранить ритм ✨</button>

    <div class="add-btns">
        <button class="btn-add" onclick="addStep(1)">1</button>
        <button class="btn-add" onclick="addStep(2)">2</button>
        <button class="btn-add" onclick="addStep(3)">3</button>
        <button class="btn-add" onclick="addStep(4)">4</button>
        <button class="btn-add" onclick="addStep(5)">5</button>
        <button class="btn-add" onclick="addStep(6)">6</button>
        <button class="btn-add" onclick="addStep(7)">7</button>
        <button class="btn-add" onclick="addStep(8)">8</button>
        <button class="btn-add" onclick="addStep(9)">9</button>
        <button class="btn-add btn-clear" onclick="clearAll()">×</button>
    </div>

    <div id="workspace"></div>
</div>

<div class="play-footer"><button id="playBtn">ПУСК</button></div>

<script>
    let audioCtx = null, isPlaying = false, nextNoteTime = 0.0, currentStepIdx = 0, tempo = 120, wakeLock = null;
    const tZone = document.getElementById('tempoZone');

    const updateTempo = (e) => {
        if (e.buttons !== 1 && !e.touches) return;
        const rect = tZone.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        tempo = 40 + (Math.min(Math.max(x / rect.width, 0), 1) * 524);
    };
    tZone.onmousedown = updateTempo; tZone.onmousemove = updateTempo; tZone.ontouchmove = (e) => { e.preventDefault(); updateTempo(e); };

    async function toggleWakeLock(on) {
        try { if (on && 'wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
        else if (wakeLock) { await wakeLock.release(); wakeLock = null; }
        } catch (err) {}
    }

    function addStep(div, state = 'hit') {
        const step = document.createElement('div');
        step.className = 'step ' + state;
        step.dataset.div = div;
        step.innerHTML = `<div class="step-num">${div}</div><div class="del-step" onclick="event.stopPropagation(); this.parentElement.remove()">×</div>`;
        step.onclick = function() {
            if (this.classList.contains('hit')) { this.classList.remove('hit'); this.classList.add('accent'); }
            else if (this.classList.contains('accent')) { this.classList.remove('accent'); }
            else { this.classList.add('hit'); }
        };
        document.getElementById('workspace').appendChild(step);
    }

    function clearAll() { document.getElementById('workspace').innerHTML = ''; }

    function playS(time, isAcc) {
        if (!audioCtx) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const vol = document.getElementById('volSlider').value;
        const level = isAcc ? vol : vol * 0.5;

        // Основной "щелчок"
        const o1 = audioCtx.createOscillator(), g1 = audioCtx.createGain();
        o1.type = 'triangle'; 
        o1.frequency.setValueAtTime(isAcc ? 2500 : 1800, time);
        g1.gain.setValueAtTime(level, time);
        g1.gain.exponentialRampToValueAtTime(0.001, time + 0.03);
        o1.connect(g1); g1.connect(audioCtx.destination);

        // Тело звука
        const o2 = audioCtx.createOscillator(), g2 = audioCtx.createGain();
        o2.type = 'sine';
        o2.frequency.setValueAtTime(isAcc ? 1200 : 800, time);
        g2.gain.setValueAtTime(level * 0.5, time);
        g2.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
        o2.connect(g2); g2.connect(audioCtx.destination);

        o1.start(time); o1.stop(time + 0.04);
        o2.start(time); o2.stop(time + 0.06);
    }

    function scheduler() {
        while (nextNoteTime < audioCtx.currentTime + 0.1) {
            const steps = document.querySelectorAll('.step');
            if (!steps.length || !isPlaying) return;
            const step = steps[currentStepIdx % steps.length];
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active-playing'));
            step.classList.add('active-playing');
            if (step.classList.contains('accent')) playS(nextNoteTime, true);
            else if (step.classList.contains('hit')) playS(nextNoteTime, false);
            nextNoteTime += (60.0 / tempo) / parseInt(step.dataset.div);
            currentStepIdx++;
        }
        if (isPlaying) setTimeout(scheduler, 25);
    }

    document.getElementById('playBtn').onclick = async () => {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        isPlaying = !isPlaying;
        if (isPlaying) {
            await toggleWakeLock(true);
            currentStepIdx = 0; nextNoteTime = audioCtx.currentTime + 0.05;
            scheduler(); document.getElementById('playBtn').innerText = "СТОП";
        } else {
            await toggleWakeLock(false);
            document.getElementById('playBtn').innerText = "ПУСК";
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active-playing'));
        }
    };

    function saveCurrentPreset() {
        const name = prompt("Название ритма:"); if (!name) return;
        const steps = Array.from(document.querySelectorAll('.step')).map(s => ({
            div: s.dataset.div, state: s.classList.contains('accent') ? 'accent' : (s.classList.contains('hit') ? 'hit' : '')
        }));
        const ps = JSON.parse(localStorage.getItem('metro_p') || '{}');
        ps[name] = { tempo, steps }; localStorage.setItem('metro_p', JSON.stringify(ps));
        renderPresets();
    }

    function renderPresets() {
        const list = document.getElementById('presetList');
        const ps = JSON.parse(localStorage.getItem('metro_p') || '{}');
        list.innerHTML = '';
        Object.keys(ps).forEach(name => {
            const el = document.createElement('div'); el.className = 'preset-item'; el.innerText = name;
            el.onclick = () => { clearAll(); tempo = ps[name].tempo; ps[name].steps.forEach(s => addStep(s.div, s.state)); };
            el.oncontextmenu = (e) => { e.preventDefault(); delete ps[name]; localStorage.setItem('metro_p', JSON.stringify(ps)); renderPresets(); };
            list.appendChild(el);
        });
    }
    renderPresets();
</script>
</body>
</html>
